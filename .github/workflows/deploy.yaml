name: Yolo Service CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USERNAME }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  REPO_NAME: YoloService
  PROJECT_DIR: /home/ubuntu/YoloService

jobs:
  test:
    name: Run API Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r torch-requirements.txt
        pip install boto3
        pip install .

    - name: Run tests
      run: |
        source .venv/bin/activate
        python -m unittest discover tests

  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan $EC2_HOST >> ~/.ssh/known_hosts

    - name: Deploy App
      run: |
        ssh $EC2_USER@$EC2_HOST << 'EOF'
          set -e
          cd ~
          if [ -d "$PROJECT_DIR" ]; then
            cd "$PROJECT_DIR"
            git pull origin main
          else
            git clone https://github.com/${{ github.repository }} "$PROJECT_DIR"
            cd "$PROJECT_DIR"
          fi

          # Check for .venv
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi

          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r torch-requirements.txt

          sudo systemctl restart yolo.service || echo "Service not found, skipping restart"
        EOF
